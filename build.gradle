apply plugin: "java"

configurations {
    jruby
    rubyTest
}

repositories {
    mavenCentral()
}


dependencies {
    jruby "org.jruby:jruby-complete:9.3.4.0"
//    rubyTest project(":embulk-core")
//    rubyTest project(":embulk-deps")
}

task gemDebug(type: JavaExec) {
    doFirst {
        delete("${buildDir}/gemContents")
        mkdir("${buildDir}/gemContents")

        delete("${buildDir}/dependencyGems")
        mkdir("${buildDir}/dependencyGems")
    }
    workingDir = file("${projectDir}/build/gemContents");
    classpath = configurations.jruby
    main = "org.jruby.Main"
//    args = ["-e", 'File.open(IO::NULL, :w.to_s){}']
    args = ["-e", 'puts :HOGEHOGE.to_s + ENV[:DEBUG_RESOLVER.to_s]']
    environment "DEBUG_RESOLVER": "1"
}

//task installDependencyGems(type: JavaExec,dependsOn: "gemContents") {
task installDependencyGems(type: JavaExec,dependsOn: "gemDebug") {
//task installDependencyGems(type: JavaExec) {
    doFirst {
        delete("${buildDir}/gemContents")
        mkdir("${buildDir}/gemContents")

        delete("${buildDir}/dependencyGems")
        mkdir("${buildDir}/dependencyGems")
    }
    workingDir = file("${projectDir}/build/gemContents");
    classpath = configurations.jruby
    main = "org.jruby.Main"
//    args = ["-rjars/setup", "-S", "gem", "install", "msgpack", "-v" , "1.1.0"]
//    args = ["-rjars/setup", "-S", "gem", "install", "--debug", "--backtrace", "msgpack", "-v" , "1.1.0"]
    args = ["-rjars/setup", "-S", "gem", "install", "--debug", "--backtrace", "-i", "${buildDir}/dependencyGems", "msgpack", "-v" , "1.1.0"]
    environment "GEM_HOME": "${buildDir}/dependencyGems"
    environment "DEBUG_RESOLVER": "1"
}

test.dependsOn("installDependencyGems")
